<UserControl
    x:Class="NetworkService.Views.NetworkDisplayView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:behaviors="clr-namespace:NetworkService.Behaviors"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:helpers="clr-namespace:NetworkService.Helpers"
    xmlns:local="clr-namespace:NetworkService.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:NetworkService.ViewModel"
    d:DesignHeight="700"
    d:DesignWidth="450"
    mc:Ignorable="d">

    <UserControl.Resources>
        <!--  Inline converter za CenterX/Y u Canvas.Left/Top  -->
        <helpers:HalfSizeConverter x:Key="HalfSizeConverter" />
    </UserControl.Resources>

    <Grid Margin="10" Background="White">

        <Grid.RowDefinitions>
            <RowDefinition Height="auto" />
            <RowDefinition Height="150" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <Grid Grid.Row="0" Margin="0,15,0,0">
            <TextBlock
                HorizontalAlignment="Center"
                FontSize="20"
                FontWeight="Bold"
                Text="{Binding Title}" />
            <ToggleButton
                Width="100"
                Height="25"
                HorizontalAlignment="Right"
                Content="Connect Mode"
                IsChecked="{Binding IsConnectMode, Mode=TwoWay}" />
        </Grid>

        <TreeView
            Grid.Row="1"
            behaviors:DragDropBehavior.DropCommand="{Binding ReturnEntityCommand}"
            ItemsSource="{Binding TrafficRoot.Children}">
            <TreeView.Resources>
                <!--  Root čvor  -->
                <HierarchicalDataTemplate DataType="{x:Type vm:TrafficRootVM}" ItemsSource="{Binding Children}">
                    <TextBlock FontWeight="Bold" Text="{Binding Name}" />
                </HierarchicalDataTemplate>

                <!--  Tipovi  -->
                <HierarchicalDataTemplate DataType="{x:Type vm:TrafficTypeGroupVM}" ItemsSource="{Binding Entities}">
                    <TextBlock FontWeight="Bold" Text="{Binding TrafficType.TrafficTypes}" />
                    <HierarchicalDataTemplate.ItemTemplate>
                        <DataTemplate>
                            <TextBlock behaviors:DragDropBehavior.EnableDrag="True" Text="{Binding Name}" />
                        </DataTemplate>
                    </HierarchicalDataTemplate.ItemTemplate>
                </HierarchicalDataTemplate>
            </TreeView.Resources>
        </TreeView>

        <Canvas Grid.Row="2" Background="Transparent">
            <!--  Linije  -->
            <ItemsControl ItemsSource="{Binding Connections}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Line
                            Stroke="Black"
                            StrokeThickness="2"
                            X1="{Binding X1}"
                            X2="{Binding X2}"
                            Y1="{Binding Y1}"
                            Y2="{Binding Y2}" />
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!--  Slotovi  -->
            <ItemsControl ItemsSource="{Binding CanvasSlots}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>

                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="Canvas.Left" Value="{Binding CenterX, Converter={StaticResource HalfSizeConverter}, ConverterParameter=80}" />
                        <Setter Property="Canvas.Top" Value="{Binding CenterY, Converter={StaticResource HalfSizeConverter}, ConverterParameter=100}" />
                    </Style>
                </ItemsControl.ItemContainerStyle>

                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border
                            Width="80"
                            Height="100"
                            behaviors:DragDropBehavior.DropCommand="{Binding DropCommand}"
                            behaviors:DragDropBehavior.EnableDrag="True"
                            Background="LightGray"
                            BorderBrush="Gray"
                            BorderThickness="1">

                            <Border.InputBindings>
                                <MouseBinding Command="{Binding SelectCommand}" MouseAction="LeftClick" />
                            </Border.InputBindings>

                            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                                <Image
                                    Width="60"
                                    Height="60"
                                    Source="{Binding Entity.TrafficType.TypeIconPath}" />
                                <TextBlock HorizontalAlignment="Center" Text="{Binding Entity.Id, StringFormat=ID: {0}, TargetNullValue=''}" />
                                <TextBlock HorizontalAlignment="Center" Text="{Binding Entity.LastValue, StringFormat=Last: {0}, TargetNullValue=''}" />
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </Canvas>
    </Grid>
</UserControl>
